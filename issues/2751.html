<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<TITLE>
    CWG Issue 2751</TITLE>
<STYLE TYPE="text/css">
  INS { text-decoration:none; font-weight:bold; background-color:#A0FFA0 }
  .INS { text-decoration:none; background-color:#D0FFD0 }
  DEL { text-decoration:line-through; background-color:#FFA0A0 }
  .DEL { text-decoration:line-through; background-color: #FFD0D0 }
  SPAN.cmnt { font-family:Times; font-style:italic }
</STYLE>
</HEAD>
<BODY>
<P><EM>This is an unofficial snapshot of the ISO/IEC JTC1 SC22 WG21
  Core Issues List revision 116b.
  See http://www.open-std.org/jtc1/sc22/wg21/ for the official
  list.</EM></P>
<P>2025-03-05</P>
<HR>
<A NAME="2751"></A><H4>2751.
  
Order of destruction for parameters for operator functions
</H4>
<B>Section: </B>8.8&#160; [<A href="https://wg21.link/stmt.dcl">stmt.dcl</A>]
 &#160;&#160;&#160;

 <B>Status: </B>NAD
 &#160;&#160;&#160;

 <B>Submitter: </B>Richard Smith
 &#160;&#160;&#160;

 <B>Date: </B>2020-06-10
  &#160;&#160;&#160;
  <B>Liaison: </B>EWG<BR>




<P>Subclause 8.8 [<A href="https://wg21.link/stmt.dcl#2">stmt.dcl</A>] paragraph 2 specifies:</P>

<BLOCKQUOTE>

Upon each transfer of control (including sequential execution of
statements) within a function from point P to point Q, all variables
with automatic storage duration that are active at P and not at Q are
destroyed in the reverse order of their construction.  ...  when a
function returns, Q is after its body.

</BLOCKQUOTE>

<P>Another description of the same rule is in a note in
8.7.1 [<A href="https://wg21.link/stmt.jump.general#2">stmt.jump.general</A>] paragraph 2:</P>

<BLOCKQUOTE>

[<I>Note 1:</I> On exit from a scope (however accomplished), objects
with automatic storage duration (6.7.6.4 [<A href="https://wg21.link/basic.stc.auto">basic.stc.auto</A>]) that
have been constructed in that scope are destroyed in the reverse order
of their construction. ...  &#8212;<I>end note</I>]

</BLOCKQUOTE>

<P>However, 12.2.2.3 [<A href="https://wg21.link/over.match.oper#2">over.match.oper</A>] paragraph 2 specifies:</P>

<BLOCKQUOTE>

... Therefore, the operator notation is first transformed to the
equivalent function-call notation as summarized in Table 18 (where @
denotes one of the operators covered in the specified
subclause). However, the operands are sequenced in the order
prescribed for the built-in operator (7.6 [<A href="https://wg21.link/expr.compound">expr.compound</A>]).

</BLOCKQUOTE>

<P>For <TT>operator+=</TT> (for example), 7.6.19 [<A href="https://wg21.link/expr.ass#1">expr.ass</A>] paragraph 1 requires:</P>

<BLOCKQUOTE>

... The right operand is sequenced before the left operand. ...

</BLOCKQUOTE>

<P>Now, consider an ABI with callee-cleanup and this example:</P>

<PRE>
  void operator&lt;&lt;(A, B);
  void operator+=(A, B);
  void (*p)(A, B) = cond ? &amp;operator&lt;&lt; : &amp;operator+=;
</PRE>

<P>In <TT>A() &lt;&lt; B()</TT>, <TT>A()</TT> is sequenced
before <TT>B()</TT>. In <TT>A() += B()</TT>, <TT>B() is sequenced
before A()</TT>.  For an ABI with callee-cleanup, this means that
<TT>operator&lt;&lt;</TT> must destroy the <TT>B</TT> parameter before
the <TT>A</TT> parameter, and <TT>operator+=</TT> must destroy
the <TT>A</TT> parameter before the <TT>B</TT> parameter.</P>

<P>But this means we have a problem emitting a call to <TT>p(A(),
B())</TT>: no order of parameter initialization guarantees that
parameters are destroyed in reverse construction order.</P>

<P>A possible implementation strategy would be to emit a second
definition of <TT>operator+=</TT> with the opposite parameter
destruction order that is used when naming the function
<TT>operator+=</TT>, e.g. when taking the address or using function
call notation (as opposed to using operator notation).</P>

<P>Another alternative is to relax the rules about destruction of
parameters in the reverse order of construction for the case of binary
operator functions and <TT>operator new</TT> and <TT>operator
delete</TT>.</P>

<P><B>Additional notes (June, 2023)</B></P>

<P>Forwarded to EWG via
<A HREF="https://github.com/cplusplus/papers/issues/1583">paper issue 1583</A>,
per decision of the CWG chair, to either affirm the intent
of the rules (requiring a more involved implementation strategy as
outlined above) or agree on a relaxation of the rules for the order of
destruction of parameters.</P>

<P><B>EWG 2023-11-07</B></P>

<P>Not a defect; the suggested implementation strategy is viable.</P>

<BR><BR>
</BODY>
</HTML>
