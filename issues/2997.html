<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<TITLE>
    CWG Issue 2997</TITLE>
<STYLE TYPE="text/css">
  INS { text-decoration:none; font-weight:bold; background-color:#A0FFA0 }
  .INS { text-decoration:none; background-color:#D0FFD0 }
  DEL { text-decoration:line-through; background-color:#FFA0A0 }
  .DEL { text-decoration:line-through; background-color: #FFD0D0 }
  SPAN.cmnt { font-family:Times; font-style:italic }
</STYLE>
</HEAD>
<BODY>
<P><EM>This is an unofficial snapshot of the ISO/IEC JTC1 SC22 WG21
  Core Issues List revision 116b.
  See http://www.open-std.org/jtc1/sc22/wg21/ for the official
  list.</EM></P>
<P>2025-03-01</P>
<HR>
<A NAME="2997"></A><H4>2997.
  
Defaulted functions with deleted definition
</H4>
<B>Section: </B>9.5.2&#160; [<A href="https://wg21.link/dcl.fct.def.default">dcl.fct.def.default</A>]
 &#160;&#160;&#160;

 <B>Status: </B>open
 &#160;&#160;&#160;

 <B>Submitter: </B>Brian Bi
 &#160;&#160;&#160;

 <B>Date: </B>2023-08-02<BR>




<P>When a function is defined as defaulted, the defaulted definition
might be deleted. The standard requires that a non-user-provided
defaulted function not be defined until it is odr-used or needed for
constant evaluation (9.5.2 [<A href="https://wg21.link/dcl.fct.def.default#5">dcl.fct.def.default</A>] paragraph 5).</P>

<P>Consider:</P>



<PRE>
  template &lt;class T&gt;
  struct X {
    static_assert(sizeof(T) &gt; 1);
  };

  template &lt;class T&gt;
  struct Y {
    bool operator==(const Y&amp; other) const {
      return true;
    }
  };

  struct Z {
    Y&lt;X&lt;char&gt;&gt; y;
    bool operator==(const Z&amp; other) const = default;
  };

  int main() {
    // Z z;
    // z == z
  }
</PRE>

<P>In order to determine whether the equality operator of <TT>Z</TT>
is deleted, it is necessary to perform argument-dependent lookup for
the equality operator that applies to <TT>Y&lt;X&lt;char&gt;&gt;</TT>,
causing instantiation of the ill-formed definition
of <TT>X&lt;char&gt;</TT>.</P>

<P>Clang, EDG, and MSVC perform the check at the end of
the <I>class-specifier</I> for <TT>Z</TT> , making the program
ill-formed.  In contrast, gcc performs the check later, if/when the
equality operator is actually used.</P>

<P>Whether a defaulted special member function (e.g. the copy
constructor, not the equality operator function) is deleted can make a
difference for class properties such as trivial copyability, affected
calling conventions and thus requiring early checking.  Is it
worthwhile to introduce an inconsistency for the equality operator
here?  On the other hand, special member functions cannot cause
argument-dependent lookup for their default definitions, so the
problem in this issue does not arise in the first place.</P>

<P>A closely related question is how to interpret
13.9.2 [<A href="https://wg21.link/temp.inst#3">temp.inst</A>] paragraph 3. Implicit instantiation of the
definition of a class template specialization instantiates the
definition of a member function only if the member function is
deleted. Does that mean, at the point of instantiation of the class,
the compiler must determine whether a defaulted definition is deleted?
</P>

<BR><BR>
</BODY>
</HTML>
