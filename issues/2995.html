<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<TITLE>
    CWG Issue 2995</TITLE>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<STYLE TYPE="text/css">
  INS { text-decoration:none; font-weight:bold; background-color:#A0FFA0 }
  .INS { text-decoration:none; background-color:#D0FFD0 }
  DEL { text-decoration:line-through; background-color:#FFA0A0 }
  .DEL { text-decoration:line-through; background-color: #FFD0D0 }
  @media (prefers-color-scheme: dark) {
    HTML { background-color:#202020; color:#f0f0f0; }
    A { color:#5bc0ff; }
    A:visited { color:#c6a8ff; }
    A:hover, a:focus { color:#afd7ff; }
    INS { background-color:#033a16; color:#aff5b4; }
    .INS { background-color: #033a16; }
    DEL { background-color:#67060c; color:#ffdcd7; }
    .DEL { background-color:#67060c; }
  }
  SPAN.cmnt { font-family:Times; font-style:italic }
</STYLE>
</HEAD>
<BODY>
<P><EM>This is an unofficial snapshot of the ISO/IEC JTC1 SC22 WG21
  Core Issues List revision 116c.
  See http://www.open-std.org/jtc1/sc22/wg21/ for the official
  list.</EM></P>
<P>2025-03-08</P>
<HR>
<A NAME="2995"></A><H4>2995.
  
Meaning of flowing off the end of a function
</H4>
<B>Section: </B>8.7.4&#160; [<A href="https://wg21.link/stmt.return">stmt.return</A>]
 &#160;&#160;&#160;

 <B>Status: </B>open
 &#160;&#160;&#160;

 <B>Submitter: </B>Brian Bi
 &#160;&#160;&#160;

 <B>Date: </B>2025-02-16<BR>




<P>Consider:</P>

<PRE>
  int foo() {
    struct S {
      ~S() noexcept(false) { throw 1; }
    } s;
  }

  int main() {
    try {
      foo();
    } catch (int x) {
      return x;
    }
  }
</PRE>

<P>Does this program exit with code 1, or does it have undefined
behavior per 8.7.4 [<A href="https://wg21.link/stmt.return#4">stmt.return</A>] paragraph 4?  Implementations
differ.</P>

<P>The crucial question is whether the undefined behaviour caused by
"flowing off the end" is before or after the closing brace of the
function body, which is where the destruction of local variables
occurs.  Current consensus appears to solidify around "after".</P>

<P>This approach is consistent with the observation that the following
two functions, given identical (valid) function bodies, should have
the same semantics:</P>

<PRE>
  void f() {{ ... }}
  void g() { ... }
</PRE>

<P><U>Suggested resolution (option 1):</U></P>

<OL>
<LI>
<P>Change in 6.9.3.1 [<A href="https://wg21.link/basic.start.main#5">basic.start.main</A>] paragraph 5 as follows:</P>

<BLOCKQUOTE>

A return statement (8.7.4 [<A href="https://wg21.link/stmt.return">stmt.return</A>]) in main has the effect
of leaving the main function (destroying any objects with automatic
storage duration) and calling std::exit with the return value as the
argument. If control flows off the end of
<DEL>the <I>compound-statement</I> of</DEL> main, the effect is
equivalent to a return with operand 0 <DEL>(see also
14.4 [<A href="https://wg21.link/except.handle">except.handle</A>])</DEL>.

</BLOCKQUOTE>
</LI>

<LI>
<P>Add a new paragraph at the end of 8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>]:</P>

<BLOCKQUOTE>

<P>[<I>Note 1:</I> A compound statement defines a block scope
(6.4 [<A href="https://wg21.link/basic.scope">basic.scope</A>]). A declaration is a statement
(8.8 [<A href="https://wg21.link/stmt.dcl">stmt.dcl</A>]). &#8212;<I>end note</I>]</P>

<P class="ins">
Control is said to <I>reach the end of a compound-statement</I>
<UL class="ins">
<LI>when its last statement completes normally and is not
a <I>jump-statement</I> (8.7 [<A href="https://wg21.link/stmt.jump">stmt.jump</A>]) and the
destruction of block variables with automatic storage duration, if
any, completes normally (8.8 [<A href="https://wg21.link/stmt.dcl">stmt.dcl</A>]), or</LI>
<LI>when the <I>compound-statement</I> is executed and contains no
statements.</LI>
</UL>
</P>

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 8.7.4 [<A href="https://wg21.link/stmt.return#4">stmt.return</A>] paragraph 4 as follows:</P>

<BLOCKQUOTE>

<INS>Control is said to <I>flow off the end</I> of a function when
control reaches the end of its <I>compound-statement</I> or that of
a <I>handler</I> of its <I>function-try-block</I>
(8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>]).</INS> Flowing off the end of a
constructor, a destructor, or a non-coroutine function with a cv void
return type <DEL>is equivalent to a return with no
operand</DEL> <INS>returns control to the caller,
except as specified in 14.4 [<A href="https://wg21.link/except.handle">except.handle</A>]</INS>. Otherwise,
flowing off the end of a function that is neither main
(6.9.3.1 [<A href="https://wg21.link/basic.start.main">basic.start.main</A>]) nor a coroutine
(9.5.4 [<A href="https://wg21.link/dcl.fct.def.coroutine">dcl.fct.def.coroutine</A>]) results in undefined behavior.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 8.7.5 [<A href="https://wg21.link/stmt.return.coroutine#3">stmt.return.coroutine</A>] paragraph 3 as follows:</P>

<BLOCKQUOTE>

If a search for the name <TT>return_void</TT> in the scope of the
promise type finds any declarations, <DEL>flowing
off</DEL> <INS>reaching</INS> the end of a
coroutine's <INS>original</INS> <I>function-body</I> <INS>(8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>])</INS>
is equivalent to a co_return with no operand; otherwise <DEL>flowing
off</DEL> <INS>reaching</INS> the end of a
coroutine's <INS>original</INS> <I>function-body</I> results in
undefined behavior.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 9.5.4 [<A href="https://wg21.link/dcl.fct.def.coroutine#6">dcl.fct.def.coroutine</A>] paragraph 6 as follows:</P>

<BLOCKQUOTE>

[<I>Note 1:</I> If <TT>return_void</TT> is found, <DEL>flowing off</DEL> <INS>reaching</INS> the end of a
<DEL>coroutine</DEL> <INS>coroutine's original <I>function-body</I>
(8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>])</INS> is equivalent to a <TT>co_return</TT>
with no operand.  Otherwise, <DEL>flowing off</DEL>
<INS>reaching</INS> the end of a <DEL>coroutine</DEL>
<INS>coroutine's original <I>function-body</I></INS> results in
undefined behavior (8.7.5 [<A href="https://wg21.link/stmt.return.coroutine">stmt.return.coroutine</A>]). &#8212;<I>end
note</I>]

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 9.5.4 [<A href="https://wg21.link/dcl.fct.def.coroutine#11">dcl.fct.def.coroutine</A>] paragraph 11 as follows:</P>

<BLOCKQUOTE>

The coroutine state is destroyed when control flows off the end of the
coroutine <INS>(8.7.4 [<A href="https://wg21.link/stmt.return">stmt.return</A>])</INS> or the destroy member
function (17.12.4.6 [<A href="https://wg21.link/coroutine.handle.resumption">coroutine.handle.resumption</A>]) of a coroutine handle
(17.12.4 [<A href="https://wg21.link/coroutine.handle">coroutine.handle</A>]) that refers to the coroutine is
invoked. In the latter case, control in the coroutine is considered to
be transferred out of the function (8.8 [<A href="https://wg21.link/stmt.dcl">stmt.dcl</A>]). The
storage for the coroutine state is released by calling a non-array
deallocation function (6.7.6.5.3 [<A href="https://wg21.link/basic.stc.dynamic.deallocation">basic.stc.dynamic.deallocation</A>]). If destroy is
called for a coroutine that is not suspended, the program has
undefined behavior.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 14.4 [<A href="https://wg21.link/except.handle#14">except.handle</A>] paragraph 14 as follows:</P>

<BLOCKQUOTE>

The currently handled exception is rethrown if control reaches the end
<INS>(8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>])</INS> of a <I>handler</I> of
the <I>function-try-block</I> of a constructor or
destructor. <DEL>Otherwise, flowing off the end of
the <I>compound-statement</I> of a handler of
a <I>function-try-block</I> is equivalent to flowing off the end of
the <I>compound-statement</I> of that function (see
8.7.4 [<A href="https://wg21.link/stmt.return">stmt.return</A>]).</DEL>

</BLOCKQUOTE>
</LI>

</OL>

<P><U>Possible resolution (option 2):</U></P>

<OL>
<LI>
<P>Change in 6.9.3.1 [<A href="https://wg21.link/basic.start.main#5">basic.start.main</A>] paragraph 5 as follows:</P>

<BLOCKQUOTE>

A return statement (8.7.4 [<A href="https://wg21.link/stmt.return">stmt.return</A>]) in main has the effect
of leaving the main function (destroying any objects with automatic
storage duration) and calling std::exit with the return value as the
argument. <DEL>If control flows off the end of
the <I>compound-statement</I> of main, the effect is equivalent to a
return with operand 0 (see also 14.4 [<A href="https://wg21.link/except.handle">except.handle</A>])</DEL>.
<INS>The statement <TT>return 0;</TT> is appended to the outermost
blocks of <TT>main</TT> (8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>]).</INS>

</BLOCKQUOTE>
</LI>

<LI>
<P>Add a new paragraph at the end of 8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>]:</P>

<BLOCKQUOTE>

<P>[<I>Note 1:</I> A compound statement defines a block scope
(6.4 [<A href="https://wg21.link/basic.scope">basic.scope</A>]). A declaration is a statement
(8.8 [<A href="https://wg21.link/stmt.dcl">stmt.dcl</A>]). &#8212;<I>end note</I>]</P>

<DIV class="ins">
<P>The <I>outermost blocks</I> of a function are
<UL>
<LI>the <I>compound-statement</I> of its <I>function-body</I> or
<I>function-try-block</I> (if any) and</LI>
<LI>the <I>compound-statement</I>s of the <I>handler</I>s of its
<I>function-try-block</I> (if any).</LI>
</UL>
[Note: A defaulted or deleted function has no outermost blocks. -- end note]
</P>

<P>
A statement <I>S</I> is <I>appended</I> to a <I>compound-statement</I>
by inserting <I>S</I> immediately prior to the closing <TT>}</TT>.
</P>

<P>The statement <TT>throw;</TT> is appended to
the <I>compound-statement</I>s of the <I>handler</I>s of
a <I>function-try-block</I> of a constructor or destructor.  The
statement <TT>return;</TT> is appended to any other outermost block of
a non-coroutine function with a <I>cv</I> <TT>void</TT> return type or
with no return type.
</P>

<P>
If control flows off the end of an outermost block of a function and
the destruction of block variables with automatic storage duration, if
any, completes normally (8.8 [<A href="https://wg21.link/stmt.dcl">stmt.dcl</A>]), the behavior is
undefined.  [Note: Control never flows off the end of <TT>main</TT>
(6.9.3.1 [<A href="https://wg21.link/basic.start.main">basic.start.main</A>]), a constructor, a destructor, or a
void-returning function. -- end note]
</P>
</DIV>

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 8.7.4 [<A href="https://wg21.link/stmt.return#4">stmt.return</A>] paragraph 4 as follows:</P>

<BLOCKQUOTE class="del">

Flowing off the end of a constructor, a destructor, or a non-coroutine
function with a cv void return type is equivalent to a return with no
operand. Otherwise, flowing off the end of a function that is neither
main (6.9.3.1 [<A href="https://wg21.link/basic.start.main">basic.start.main</A>]) nor a coroutine
(9.5.4 [<A href="https://wg21.link/dcl.fct.def.coroutine">dcl.fct.def.coroutine</A>]) results in undefined behavior.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 8.7.5 [<A href="https://wg21.link/stmt.return.coroutine#3">stmt.return.coroutine</A>] paragraph 3 as follows:</P>

<BLOCKQUOTE class="del">

If a search for the name <TT>return_void</TT> in the scope of the
promise type finds any declarations, flowing off the end of a
coroutine's <I>function-body</I> is equivalent to a co_return with no
operand; otherwise flowing offthe end of a coroutine's
<I>function-body</I> results in undefined behavior.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 9.5.4 [<A href="https://wg21.link/dcl.fct.def.coroutine#6">dcl.fct.def.coroutine</A>] paragraph 6 as follows:</P>

<BLOCKQUOTE>

If searches for the names return_void and return_value in the scope of
the promise type each find any declarations, the program is
ill-formed.
<INS>Otherwise, if the search for the name <TT>return_void</TT> in the
scope of the promise type finds any declarations, the statement
<TT>co_return;</TT> is appended to the coroutine's original
<I>function-body</I> (8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>],
8.7.5 [<A href="https://wg21.link/stmt.return.coroutine">stmt.return.coroutine</A>]).</INS>
<DEL>[<I>Note 1:</I> If <TT>return_void</TT> is found, flowing off the
end of a coroutine is equivalent to a <TT>co_return</TT> with no
operand. Otherwise, flowing</DEL> <INS>Flowing</INS> off the end of a
<DEL>coroutine</DEL> <INS>coroutine's original
<I>function-body</I></INS> results in undefined behavior
<DEL>(8.7.5 [<A href="https://wg21.link/stmt.return.coroutine">stmt.return.coroutine</A>])</DEL>. <DEL>&#8212;<I>end
note</I>]</DEL>

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 9.5.4 [<A href="https://wg21.link/dcl.fct.def.coroutine#11">dcl.fct.def.coroutine</A>] paragraph 11 as follows:</P>

<BLOCKQUOTE>

The coroutine state is destroyed <DEL>when control flows off the end
of the coroutine</DEL> <INS>at the end of its
replacement <I>function-body</I> (8.4 [<A href="https://wg21.link/stmt.block">stmt.block</A>])</INS> or
when the destroy member function (17.12.4.6 [<A href="https://wg21.link/coroutine.handle.resumption">coroutine.handle.resumption</A>]) of a
coroutine handle (17.12.4 [<A href="https://wg21.link/coroutine.handle">coroutine.handle</A>]) that refers to the
coroutine is invoked. In the latter case, control in the coroutine is
considered to be transferred out of the function
(8.8 [<A href="https://wg21.link/stmt.dcl">stmt.dcl</A>]). The storage for the coroutine state is
released by calling a non-array deallocation function
(6.7.6.5.3 [<A href="https://wg21.link/basic.stc.dynamic.deallocation">basic.stc.dynamic.deallocation</A>]). If destroy is called for a coroutine
that is not suspended, the program has undefined behavior.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 14.4 [<A href="https://wg21.link/except.handle#14">except.handle</A>] paragraph 14 as follows:</P>

<BLOCKQUOTE class="del">

The currently handled exception is rethrown if control reaches the end
of a <I>handler</I> of
the <I>function-try-block</I> of a constructor or
destructor. Otherwise, flowing off the end of
the <I>compound-statement</I> of a handler of
a <I>function-try-block</I> is equivalent to flowing off the end of
the <I>compound-statement</I> of that function (see
8.7.4 [<A href="https://wg21.link/stmt.return">stmt.return</A>]).

</BLOCKQUOTE>
</LI>

</OL>

<BR><BR>
</BODY>
</HTML>
