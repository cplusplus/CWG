<HTML>
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=us-ascii">
<TITLE>
    CWG Issue 2756</TITLE>
<STYLE TYPE="text/css">
  INS { text-decoration:none; font-weight:bold; background-color:#A0FFA0 }
  .INS { text-decoration:none; background-color:#D0FFD0 }
  DEL { text-decoration:line-through; background-color:#FFA0A0 }
  .DEL { text-decoration:line-through; background-color: #FFD0D0 }
  SPAN.cmnt { font-family:Times; font-style:italic }
</STYLE>
</HEAD>
<BODY>
<P><EM>This is an unofficial snapshot of the ISO/IEC JTC1 SC22 WG21
  Core Issues List revision 116.
  See http://www.open-std.org/jtc1/sc22/wg21/ for the official
  list.</EM></P>
<P>2024-12-19</P>
<HR>
<A NAME="2756"></A><H4>2756.
  
Completion of initialization by delegating constructor
</H4>
<B>Section: </B>11.9&#160; [<A href="https://wg21.link/class.init">class.init</A>]
 &#160;&#160;&#160;

 <B>Status: </B>review
 &#160;&#160;&#160;

 <B>Submitter: </B>Brian Bi
 &#160;&#160;&#160;

 <B>Date: </B>2023-06-20<BR>




<P>Subclause 6.7.4 [<A href="https://wg21.link/basic.life#1">basic.life</A>] paragraph 1 specifies:</P>

<BLOCKQUOTE>

... The lifetime of an object of type T begins when:
<UL>
<LI>storage with the proper alignment and size for type T is obtained,
and</LI>
<LI>its initialization (if any) is complete (including vacuous
initialization) (9.4 [<A href="https://wg21.link/dcl.init">dcl.init</A>]),</LI>
</UL>

except that ...

</BLOCKQUOTE>

<P>It is unclear whether initialization is considered complete when
the (ultimate) target constructor completes, or when the outermost
delegating constructor completes.  Subclause 14.3 [<A href="https://wg21.link/except.ctor#4">except.ctor</A>] paragraph 4 suggests it is the former:</P>

<BLOCKQUOTE>

If the <I>compound-statement</I> of the <I>function-body</I> of a
delegating constructor for an object exits via an exception, the
object's destructor is invoked. ...

</BLOCKQUOTE>

<P><B>Proposed resolution (approved by CWG 2023-07-14) [SUPERSEDED]:</B></P>

<OL>
<LI>
<P>Split and change 11.9.3 [<A href="https://wg21.link/class.base.init#9">class.base.init</A>] paragraph 9 as follows:</P>

<BLOCKQUOTE>

<P>[Note 3: An abstract class ... -- end note ]
<DEL>An attempt to initialize more than one non-static data member of a
union renders the program ill-formed.</DEL>
[Note 4: After the call to a constructor for class X ... -- end note ]
[Example 6: ... -- end example ]</P>

<P class="ins">
An attempt to initialize more than one non-static data
member of a union renders the program ill-formed.</P>

<P class="ins">
An object's initialization is considered complete when a
non-delegating constructor for that object returns. [Note: Therefore,
an object's lifetime can begin (6.7.4 [<A href="https://wg21.link/basic.life">basic.life</A>]) before all
delegating constructors have completed. -- end note]</P>

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 6.7.4 [<A href="https://wg21.link/basic.life#1.2">basic.life</A>] bullet 1.2 as follows:</P>

<BLOCKQUOTE>

... The lifetime of an object of type T begins when:
<UL>
<LI>storage with the proper alignment and size for type T is obtained,
and</LI>
<LI>its initialization (if any) is complete (including vacuous
initialization) (9.4 [<A href="https://wg21.link/dcl.init">dcl.init</A>]<INS>,
11.9.3 [<A href="https://wg21.link/class.base.init">class.base.init</A>]</INS>),</LI>
</UL>

except that ...

</BLOCKQUOTE>

</LI>
</OL>

<P><B>CWG 2023-10-20</B></P>

<P>Utterances about "during construction or destruction" in
11.9.5 [<A href="https://wg21.link/class.cdtor">class.cdtor</A>] need to be adjusted.</P>

<P><U>Possible resolution:</U></P>

<OL>
<LI>
<P>Split and change 11.9.3 [<A href="https://wg21.link/class.base.init#9">class.base.init</A>] paragraph 9 as follows:</P>

<BLOCKQUOTE>

<P>[Note 3: An abstract class ... -- end note ]
<DEL>An attempt to initialize more than one non-static data member of a
union renders the program ill-formed.</DEL>
[Note 4: After the call to a constructor for class X ... -- end note ]
[Example 6: ... -- end example ]</P>

<P class="ins">
An attempt to initialize more than one non-static data
member of a union renders the program ill-formed.</P>

<P class="ins">
An object's initialization is considered complete when a
non-delegating constructor for that object returns. [Note: Therefore,
an object's lifetime can begin (6.7.4 [<A href="https://wg21.link/basic.life">basic.life</A>]) before all
delegating constructors have completed. -- end note]</P>

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 6.7.4 [<A href="https://wg21.link/basic.life#1.2">basic.life</A>] bullet 1.2 as follows:</P>

<BLOCKQUOTE>

... The lifetime of an object of type T begins when:
<UL>
<LI>storage with the proper alignment and size for type T is obtained,
and</LI>
<LI>its initialization (if any) is complete (including vacuous
initialization) (9.4 [<A href="https://wg21.link/dcl.init">dcl.init</A>]<INS>,
11.9.3 [<A href="https://wg21.link/class.base.init">class.base.init</A>]</INS>),</LI>
</UL>

except that ...

</BLOCKQUOTE>

</LI>

<LI>
<P>Change in 11.9.5 [<A href="https://wg21.link/class.cdtor#2">class.cdtor</A>] paragraph 2 as follows:</P>

<BLOCKQUOTE>

During the <DEL>construction</DEL> <INS>initialization</INS> of an
object, if the value of the object or any of its subobjects is
accessed through a glvalue that is not obtained, directly or
indirectly, from the constructor's this pointer, the value of the
object or subobject thus obtained is unspecified.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 11.9.5 [<A href="https://wg21.link/class.cdtor#4">class.cdtor</A>] paragraph 4 as follows:</P>

<BLOCKQUOTE>

Member functions, including virtual functions
(11.7.3 [<A href="https://wg21.link/class.virtual">class.virtual</A>]), can be called during construction or
destruction (11.9.3 [<A href="https://wg21.link/class.base.init">class.base.init</A>]).  When a virtual function is
called directly or indirectly from a constructor or from a destructor,
including during the <DEL>construction</DEL> <INS>initialization</INS>
or destruction of the class's non-static data members, and the object
to which the call applies is the object (call it x) <DEL>under
construction or destruction</DEL> <INS>being initialized or
destroyed</INS>, the function called is the final overrider in the
constructor's or destructor's class and not one overriding it in a
more-derived class. If the virtual function call uses an explicit
class member access (7.6.1.5 [<A href="https://wg21.link/expr.ref">expr.ref</A>]) and the object
expression refers to the complete object of x or one of that object's
base class subobjects but not x or one of its base class subobjects,
the behavior is undefined.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 11.9.5 [<A href="https://wg21.link/class.cdtor#5">class.cdtor</A>] paragraph 5 as follows:</P>

<BLOCKQUOTE>

The typeid operator (7.6.1.8 [<A href="https://wg21.link/expr.typeid">expr.typeid</A>]) can be used during
construction or destruction (11.9.3 [<A href="https://wg21.link/class.base.init">class.base.init</A>]). When typeid
is used in a constructor (including the <I>mem-initializer</I> or
default member initializer (11.4 [<A href="https://wg21.link/class.mem">class.mem</A>]) for a
non-static data member) or in a destructor, or used in a function
called (directly or indirectly) from a constructor or destructor, if
the operand of typeid refers to the object <DEL>under construction or
destruction</DEL> <INS>being initialized or destroyed</INS>, typeid
yields the std::type_info object representing the constructor or
destructor's class. If the operand of typeid refers to the
object <DEL>under construction or destruction</DEL> <INS>being
initialized or destroyed</INS> and the static type of the operand is
neither the constructor or destructor's class nor one of its bases,
the behavior is undefined.

</BLOCKQUOTE>
</LI>

<LI>
<P>Change in 11.9.5 [<A href="https://wg21.link/class.cdtor#6">class.cdtor</A>] paragraph 6 as follows:</P>

<BLOCKQUOTE>

dynamic_casts (7.6.1.7 [<A href="https://wg21.link/expr.dynamic.cast">expr.dynamic.cast</A>]) can be used during
construction or destruction (11.9.3 [<A href="https://wg21.link/class.base.init">class.base.init</A>]). When a
dynamic_cast is used in a constructor (including
the <I>mem-initializer</I> or default member initializer for a
non-static data member) or in a destructor, or used in a function
called (directly or indirectly) from a constructor or destructor, if
the operand of the dynamic_cast refers to the object <DEL>under
construction or destruction</DEL> <INS>being initialized or
destroyed</INS>, this object is considered to be a most derived object
that has the type of the constructor or destructor's class. If the
operand of the dynamic_cast refers to the object <DEL>under
construction or destruction</DEL> <INS>being initialized or
destroyed</INS> and the static type of the operand is not a pointer to
or object of the constructor or destructor's own class or one of its
bases, the dynamic_cast results in undefined behavior.

</BLOCKQUOTE>
</LI>
</OL>

<BR><BR>
</BODY>
</HTML>
